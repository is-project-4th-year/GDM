{% extends 'base.html' %}

{% block title %}Patient List - GDM Predictor{% endblock %}

{% block extra_css %}
<style>
    .patient-list-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 0;
    }

    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 1rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
        background: var(--white);
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .search-section {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex: 1;
        max-width: 400px;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    .btn-search {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-new-patient {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, var(--success), #059669);
        color: white;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-new-patient:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .patients-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .patient-card {
        background: var(--white);
        border-radius: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .patient-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .patient-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    .patient-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .patient-info h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.25rem;
    }

    .patient-id {
        font-size: 0.875rem;
        color: var(--gray-500);
        font-weight: 500;
    }

    .risk-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .risk-low {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .risk-medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .risk-high {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .risk-none {
        background: var(--gray-100);
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
    }

    .patient-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        padding: 0.5rem;
        background: var(--gray-50);
        border-radius: 0.5rem;
    }

    .detail-label {
        color: var(--gray-600);
        font-weight: 500;
    }

    .detail-value {
        color: var(--gray-800);
        font-weight: 600;
    }

    .patient-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .btn-small {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        flex: 1;
        justify-content: center;
    }

    .btn-assess {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        font-weight: 600;
    }

    .btn-history {
        background: var(--gray-600);
        color: white;
    }

    .btn-small:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-600);
        background: var(--white);
        border-radius: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--gray-400);
        margin-bottom: 1rem;
    }

    .stats-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--white);
        border-radius: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        padding: 1.5rem;
        text-align: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--gray-600);
        font-size: 0.875rem;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .patients-grid {
            grid-template-columns: 1fr;
        }

        .actions-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .search-section {
            max-width: none;
        }

        .patient-details {
            grid-template-columns: 1fr;
        }

        .patient-actions {
            flex-direction: column;
        }

        .stats-summary {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="patient-list-container">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{{ url_for('dashboard') }}">
            <i class="fas fa-home"></i> Dashboard
        </a>
        <i class="fas fa-chevron-right"></i>
        <span>Patient List</span>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Select Patient</h1>
        <p>Choose a patient to perform GDM risk assessment</p>
    </div>

    <!-- Statistics Summary -->
    <div class="stats-summary">
        <div class="stat-card">
            <div class="stat-value">{{ patients|length }}</div>
            <div class="stat-label">Total Patients</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ patients|selectattr('latest_risk', 'equalto', 'High')|list|length }}
            </div>
            <div class="stat-label">High Risk</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ patients|selectattr('latest_risk', 'equalto', 'Medium')|list|length }}
            </div>
            <div class="stat-label">Medium Risk</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {{ patients|selectattr('assessment_count', 'greaterthan', 0)|list|length }}
            </div>
            <div class="stat-label">Assessed</div>
        </div>
    </div>

    <!-- Actions Bar -->
    <div class="actions-bar">
        <div class="search-section">
            <input 
                type="text" 
                class="search-input" 
                placeholder="Search patients by name or phone..."
                value="{{ search_term }}"
                id="search-input"
            >
            <button class="btn-search" onclick="searchPatients()">
                <i class="fas fa-search"></i>
                Search
            </button>
        </div>
        <a href="{{ url_for('create_patient') }}" class="btn-new-patient">
            <i class="fas fa-plus"></i>
            Add New Patient
        </a>
    </div>

    <!-- Patients Grid -->
    {% if patients %}
    <div class="patients-grid" id="patients-grid">
        {% for patient in patients %}
        <div class="patient-card" onclick="selectPatient('{{ patient.id }}')">
            <div class="patient-header">
                <div class="patient-info">
                    <h3>{{ patient.first_name }} {{ patient.last_name }}</h3>
                    <div class="patient-id">ID: {{ patient.id }}</div>
                </div>
                {% if patient.latest_risk %}
                    <div class="risk-badge risk-{{ patient.latest_risk.lower() }}">
                        {{ patient.latest_risk }} Risk
                    </div>
                {% else %}
                    <div class="risk-badge risk-none">No Assessment</div>
                {% endif %}
            </div>
            
            <div class="patient-details">
                <div class="detail-item">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">{{ patient.phone or 'N/A' }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Assessments:</span>
                    <span class="detail-value">{{ patient.assessment_count or 0 }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Last Visit:</span>
                    <span class="detail-value">
                        {% if patient.last_assessment %}
                            {{ patient.last_assessment.split(' ')[0] }}
                        {% else %}
                            Never
                        {% endif %}
                    </span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Age:</span>
                    <span class="detail-value">
                        {% if patient.date_of_birth %}
                            {% set age = moment(patient.date_of_birth).age %}
                            {{ age }} years
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="patient-actions">
                <a href="{{ url_for('patient_assessment', patient_id=patient.id) }}" 
                   class="btn-small btn-assess" 
                   onclick="event.stopPropagation();">
                    <i class="fas fa-stethoscope"></i> New Assessment
                </a>
                {% if patient.assessment_count > 0 %}
                <a href="{{ url_for('patient_history', patient_id=patient.id) }}" 
                   class="btn-small btn-history" 
                   onclick="event.stopPropagation();">
                    <i class="fas fa-history"></i> History
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3>No Patients Found</h3>
        {% if search_term %}
        <p>No patients match your search criteria "{{ search_term }}"</p>
        <button onclick="clearSearch()" class="btn btn-secondary" style="margin-top: 1rem;">
            <i class="fas fa-times"></i> Clear Search
        </button>
        {% else %}
        <p>Get started by creating your first patient record</p>
        <a href="{{ url_for('create_patient') }}" class="btn btn-primary" style="margin-top: 1rem;">
            <i class="fas fa-plus"></i> Create First Patient
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Search functionality
    function searchPatients() {
        const searchTerm = document.getElementById('search-input').value;
        const currentUrl = new URL(window.location);
        
        if (searchTerm.trim()) {
            currentUrl.searchParams.set('search', searchTerm.trim());
        } else {
            currentUrl.searchParams.delete('search');
        }
        
        window.location.href = currentUrl.toString();
    }

    function clearSearch() {
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.delete('search');
        window.location.href = currentUrl.toString();
    }

    // Patient selection
    function selectPatient(patientId) {
        // This could open a modal with options or directly go to assessment
        const options = confirm('What would you like to do?\n\nOK = New Assessment\nCancel = View History');
        
        if (options) {
            window.location.href = `/patient/${patientId}/assess`;
        } else {
            window.location.href = `/patient/${patientId}/history`;
        }
    }

    // Real-time search
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPatients();
        }
    });

    // Auto-focus search if there are patients
    {% if patients %}
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        if (searchInput && !searchInput.value) {
            searchInput.focus();
        }
    });
    {% endif %}

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Press 'N' to create new patient
        if (e.key === 'n' || e.key === 'N') {
            if (!e.target.matches('input, textarea')) {
                window.location.href = "{{ url_for('create_patient') }}";
            }
        }
        
        // Press '/' to focus search
        if (e.key === '/') {
            if (!e.target.matches('input, textarea')) {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
        }
    });

    // Add loading state for patient cards
    document.querySelectorAll('.patient-card').forEach(card => {
        card.addEventListener('click', function() {
            this.style.opacity = '0.7';
            this.style.transform = 'scale(0.98)';
        });
    });
</script>
{% endblock %}